<!-- HTML header for doxygen 1.9.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>flexPTP: Introduction and overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="large-top-height.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
</script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript">
    DoxygenAwesomeInteractiveToc.init()
</script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="flexPTP_logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">flexPTP<span id="projectnumber">&#160;1.0</span>
   </div>
   <div id="projectbrief">An IEEE 1588 PTP implementation designed for microcontrollers</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Introduction and overview </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="image">
<img src="flexPTP_logo_long.png" alt=""/>
</div>
    <p><em>Accurate time synchronization on low-energy, microcontroller based embedded systems is not a feat of the future anymore with the flexPTP library on our side.</em></p>
<div class="image">
<img src="TIVA.gif" alt=""/>
</div>
    <p><b>flexPTP has been designed with low resource utilization in mind. The library can easily fit into 20K program and 10K data memory space with all features enabled. The library has been ported to and tested on ARM Cortex-M4 and Cortex-M7 based microcontrollers from several manufacturers (e.g. STM32F4xx, STM32F7xx, STM32H7xx, TM4C1294 etc.). According to simple measurements published in several papers of ours, with the help of the library even low-power systems achieved a synchronization precision of tens of nanoseconds.</b></p>
<p><em>The library is released under the MIT license with the endeavour to provide quick and compact solution for embedded time synchronization.</em></p>
<h2><a class="anchor" id="autotoc_md15"></a>
Quick intro</h2>
<p>Clueless where to start first? We recommend newcomers to start playing around with some complete <a class="el" href="examples.html">Examples</a>, then continue with the <a class="el" href="swoperation.html">Software structure</a> chapter and finally read <a class="el" href="porting.html">Porting and configuration</a> guide.</p>
<h2><a class="anchor" id="autotoc_md16"></a>
Features</h2>
<p>flexPTP offers the following capabilities:</p>
<ul>
<li><a href="https://ieeexplore.ieee.org/document/9120376">IEEE 1588</a> compatible <b>slave</b> and <b>master</b> OC implementation</li>
<li>supports <b>E2E</b> and <b>P2P</b> delay mechanisms</li>
<li>supports <b>L2</b> and <b>L4</b> transport mechanisms</li>
<li>supports <b>one-step</b> and <b>two-step</b> signaling modes</li>
<li>can operate as a <b>IEEE 802.1AS</b> clock (slave or master)</li>
<li>offers <b>PID</b> and <b>Kalman-filter</b> servos</li>
<li>supports lwIP and EtherLib as underlying network stack</li>
<li>features a rich set of runtime-configurable options</li>
<li>features numerous logging features</li>
<li>provides operational statistics</li>
<li>provides means to compensate hardware layer delays</li>
<li>provides <b>CMake-support</b>, compiles into a library</li>
<li>provides a simple servo (controller) interface</li>
<li>automatically cooperates with certain CLI terminals</li>
</ul>
<h2><a class="anchor" id="autotoc_md17"></a>
Platforms and examples</h2>
<p>The library package ships with hardware ports for several platforms, including:</p>
<ul>
<li><b>TM4C1294</b> (<em>lwIP</em>)<ul>
<li>Example: <a href="https://github.com/epagris/flexPTP-demo-TM4C1294">EK-TM4C1294XL Connected LaunchPad flexPTP demo</a></li>
</ul>
</li>
<li><b>STM32F4xx</b> (<em>EtherLib</em>/_lwip_)<ul>
<li>Example: <a href="https://github.com/epagris/flexPTP-demo-NUCLEO-F439ZI">STM32 NUCLEO-F439ZI flexPTP demo</a></li>
</ul>
</li>
<li><b>STM32F7xx</b> (<em>EtherLib</em>/_lwip_)<ul>
<li>Example: <a href="https://github.com/epagris/flexPTP-demo-NUCLEO-F746ZG">STM32 NUCLEO-F746ZG flexPTP demo</a></li>
</ul>
</li>
<li><b>STM32H7xx</b> (<em>EtherLib</em>/_lwip_)<ul>
<li>Example: <a href="https://github.com/epagris/flexPTP-demo-NUCLEO-H743ZI">STM32 NUCLEO-H743ZI flexPTP demo</a>, <a href="https://github.com/epagris/flexPTP-demo-NUCLEO-H745ZI-Q/">STM32 <b>dual-core</b> NUCLEO-H745ZI-Q flexPTP demo</a></li>
</ul>
</li>
<li><b>MK64F</b>: (<em>lwip</em>)<ul>
<li>Example: <a href="https://github.com/epagris/flexPTP-demo-FRDM-K64F">NXP FRDM-K64F flexPTP demo</a></li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md18"></a>
Requirements</h2>
<p>Apart from the access to a working C compiler, only the following two criteria must be met to compile flexPTP:</p>
<ul>
<li>The library relies on the services of the <a href="https://www.freertos.org/">FreeRTOS</a> embedded operating system thus it is required to integrate the library.</li>
<li>A compatible network stack library and target platform Ethernet driver is required. Currently <a href="https://github.com/lwip-tcpip/lwip">Lightweight IP</a> (lwip) and <a href="https://gitea.epagris.com/epagris/EtherLib">EtherLib</a> are supported.</li>
</ul>
<h2><a class="anchor" id="autotoc_md19"></a>
Porting and options</h2>
<p>For elaborate information on porting and options refer to <a class="el" href="porting.html">Porting and configuration</a>.</p>
<h3><a class="anchor" id="autotoc_md20"></a>
Network stack requirements</h3>
<p>The network stack (lwIP or EtherLib) must provide tools to communicate receive and transmit timestamps along the PTP messages. It's the developers responsibility to make the timestamps captured in the hardware available to the flexPTP module.</p>
<p>For better understanding how timestamps are fed into flexPTP, refer to <a class="el" href="task__ptp_8c.html#a1409be7128c102f50cc590ec0aa817e0">ptp_receive_enqueue()</a> in <a class="el" href="task__ptp_8c.html">task_ptp.c</a>.</p>
<h4><a class="anchor" id="autotoc_md21"></a>
lwIP</h4>
<p>The lwIP (up to v2.2.0) has not been designed to support timestamp propagation right away. A possible workaround is by extending the <code>pbuf</code> structure so that it can carry the timestamps and the usual packet data as well through defining the <code>LWIP_PBUF_CUSTOM_DATA</code> macro.</p>
<div class="fragment"><div class="line"><span class="comment">// Main packet buffer struct</span></div>
<div class="line"><span class="keyword">struct </span>pbuf {</div>
<div class="line">  <span class="comment">/* ... */</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Contents of LWIP_PBUF_CUSTOM_DATA&gt;&gt;</span></div>
<div class="line">  <span class="comment">/* PTP timestamp fields */</span></div>
<div class="line">  u32_t time_s, time_ns;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Transmit callback function */</span></div>
<div class="line">  void (*tx_cb)(<span class="keyword">struct </span>pbuf * pPbuf);</div>
<div class="line">  <span class="comment">// &lt;&lt;Contents of LWIP_PBUF_CUSTOM_DATA</span></div>
<div class="line">};</div>
</div><!-- fragment --><p>The low level lwIP-Ethernet driver must be instrumented to communicate receive and transmit timestamps. Fortunately, developing such an extension is not that difficult, at all. As an example you can find a guide <a class="el" href="_h743_ethernetif_modifications.html">here</a> that showcases our amendments to the vendor-provided <code>ethernetif.c</code> low level lwIP Ethernet driver file for the STM32H743 platform. You can also find examples on PTP-compatible lwip low-level drivers among the <a class="el" href="examples.html">example projects</a>.</p>
<h4><a class="anchor" id="autotoc_md22"></a>
EtherLib</h4>
<p>EtherLib provides immediate support for passing timestamp with packet data. For more information, visit the <a href="https://gitea.epagris.com/epagris/EtherLib">EtherLib repository</a>.</p>
<h3><a class="anchor" id="autotoc_md23"></a>
Compile-time options</h3>
<p>The flexPTP library expects hardware constants and parameters as well as default settings passed in a <code>flexptp_options.h</code> header file.</p>
<h2><a class="anchor" id="autotoc_md24"></a>
Building</h2>
<p>The preferred and encouraged way to compile the library is to harness the built-in CMake support, although, building using any IDE is possible. The only requirement is a working a C (cross-)compiler (e.g. <code>arm-none-eabi-gcc</code>). More, detailed description on this topic: <a class="el" href="building.html">Compiling the library</a>.</p>
<h2><a class="anchor" id="autotoc_md25"></a>
Usage</h2>
<h3><a class="anchor" id="autotoc_md26"></a>
Startup and shutdown</h3>
<p>The flexPTP module can be started/stopped by calling <a class="el" href="task__ptp_8c.html#a2d483d3c32b3890d8c699018e48e45cd">reg_task_ptp()</a> and <a class="el" href="task__ptp_8c.html#a5fd98059e4c2ec1004c74064e17cbe4c">unreg_task_ptp()</a>.</p>
<h3><a class="anchor" id="autotoc_md27"></a>
Runtime operation</h3>
<p>The library has an extensive interface for manipulating the PTP operation mode during runtime (e.g. change profile, enable logging etc.), learn more <a class="el" href="project_organization.html">here</a>. The flexPTP includes a CLI interface as well, if a suitable CLI library is given, flexPTP offers the following multitude of CLI commands:</p>
<div class="fragment"><div class="line">ptp servo params [<a class="code hl_variable" href="pid__controller_8c.html#a09cfc766a233ad617270562cc4146d07">Kp</a> <a class="code hl_variable" href="pid__controller_8c.html#a98268d71502ba080d88a9b1f50fdbe80">Kd</a>]                           Set or query K_p and K_d servo parameters</div>
<div class="line">ptp servo log internals {on|off}                   Enable or disable logging of servo internals</div>
<div class="line">ptp reset                                          Reset PTP subsystem</div>
<div class="line">ptp servo offset [offset_ns]                       Set or query clock offset</div>
<div class="line">ptp log {def|corr|ts|info|locked|bmca} {on|off}    Turn on or off logging</div>
<div class="line">time [ns]                                          Print time</div>
<div class="line">ptp master [[un]prefer] [clockid]                  Master clock settings</div>
<div class="line">ptp info                                           Print PTP info</div>
<div class="line">ptp domain [domain]                                Print or set PTP domain</div>
<div class="line">ptp addend [addend]                                Print or set addend   &lt;--- ADDEND <span class="keyword">interface </span>ONLY</div>
<div class="line">ptp tuning [tuning]                                Print or set tuning   &lt;--- HLT interface ONLY</div>
<div class="line">ptp transport [{ipv4|802.3}]                       Set or get PTP transport layer</div>
<div class="line">ptp delmech [{e2e|p2p}]                            Set or get PTP delay mechanism</div>
<div class="line">ptp transpec [{def|gPTP}]                          Set or get PTP transportSpecific field (majorSdoId)</div>
<div class="line">ptp profile [preset [&lt;name&gt;]]                      Print or set PTP profile, or list available presets</div>
<div class="line">ptp tlv [preset [name]|unload]                     Print or set TLV-chain, or list available TLV presets</div>
<div class="line">ptp pflags [&lt;flags&gt;]                               Print or set profile flags</div>
<div class="line">ptp period &lt;delreq|sync|ann&gt; [&lt;lp&gt;|matched]        Print or set log. periods</div>
<div class="line">ptp coarse [threshold]                             Print or set coarse correction threshold</div>
<div class="line">ptp priority [&lt;p1&gt; &lt;p2&gt;]                           Print or set clock priority fields</div>
<div class="ttc" id="apid__controller_8c_html_a09cfc766a233ad617270562cc4146d07"><div class="ttname"><a href="pid__controller_8c.html#a09cfc766a233ad617270562cc4146d07">Kp</a></div><div class="ttdeci">static float Kp</div><div class="ttdoc">Proportional factor.</div><div class="ttdef"><b>Definition:</b> <a href="pid__controller_8c_source.html#l00036">pid_controller.c:36</a></div></div>
<div class="ttc" id="apid__controller_8c_html_a98268d71502ba080d88a9b1f50fdbe80"><div class="ttname"><a href="pid__controller_8c.html#a98268d71502ba080d88a9b1f50fdbe80">Kd</a></div><div class="ttdeci">static float Kd</div><div class="ttdoc">Differentiating factor.</div><div class="ttdef"><b>Definition:</b> <a href="pid__controller_8c_source.html#l00038">pid_controller.c:38</a></div></div>
</div><!-- fragment --><p> The library can load a previously stored or save the current configuration from and to a non-volatile storage with the help of some glue code.</p>
<h2><a class="anchor" id="autotoc_md28"></a>
Performance measurements</h2>
<p>Our library achieves decent synchronization performance, usually <b>better than 100ns timing precision</b> even on low-power microcontrollers. The below measurements were made using the nowadays common gPTP (802.1AS) profile. Logs corresponding to each plot are located in the "manual/dumps/" folder.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">TM4C1294   </th><th class="markdownTableHeadCenter">STM32F407   </th><th class="markdownTableHeadCenter">STM32H743    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter"><img src="tm4c1294-gPTP.svg" alt="" style="pointer-events: none;" class="inline" title="TM4C1294-gPTP"/>      </td><td class="markdownTableBodyCenter"><img src="stm32f407-gPTP.svg" alt="" style="pointer-events: none;" class="inline" title="STM32F407-gPTP"/>      </td><td class="markdownTableBodyCenter"><img src="stm32h743-gPTP.svg" alt="" style="pointer-events: none;" class="inline" title="STM32H743-gPTP"/>      </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md29"></a>
Related papers</h2>
<p><a href="https://ieeexplore.ieee.org/document/10747727">Time Synchronization Extension for the IO-Link Industrial Communication Protocol</a></p>
<p><a href="https://ieeexplore.ieee.org/document/9805958/">Distributed Measurement System for Performance Evaluation of Embedded Clock Synchronization Solutions</a></p>
<p><a href="https://ieeexplore.ieee.org/document/9615250">Portable, PTP-based Clock Synchronization Implementation for Microcontroller-based Systems and its Performance Evaluation</a></p>
<p><a href="https://ieeexplore.ieee.org/document/9918455/">Synchronization of Sampling in a Distributed Audio Frequency Range Data Acquisition System Utilizing Microcontrollers</a></p>
<p><a href="https://ieeexplore.ieee.org/document/10178979/">Methods of Peripheral Synchronization in Real-Time Cyber-Physical Systems</a></p>
<h2><a class="anchor" id="autotoc_md30"></a>
Maintainers, contributors</h2>
<ul>
<li>András Wiesner (<a href="https://github.com/epagris">Epagris</a>)</li>
<li>Tamás Kovácsházy (<a href="https://github.com/khazy">khazy</a>)</li>
</ul>
<h2><a class="anchor" id="autotoc_md31"></a>
Licensing</h2>
<p>The flexPTP library is release under the MIT license.</p>
<h2><a class="anchor" id="autotoc_md32"></a>
See also</h2>
<p><a class="el" href="examples.html">Examples</a>, <a class="el" href="project_organization.html">Project organization</a></p>
<p>Documentation style: <a href="https://github.com/jothepro/doxygen-awesome-css/tree/main">doxygen-awesome-css</a> by jothepro</p>
<dl class="section copyright"><dt>Copyright</dt><dd>András Wiesner, 2019-2025 </dd></dl>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6 </li>
  </ul>
</div>
</body>
</html>

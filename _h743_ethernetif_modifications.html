<!-- HTML header for doxygen 1.9.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>flexPTP: STM32H743 low level lwIP driver modifications to support timestamp communication</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="large-top-height.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
</script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript">
    DoxygenAwesomeInteractiveToc.init()
</script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="flexPTP_logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">flexPTP<span id="projectnumber">&#160;1.0</span>
   </div>
   <div id="projectbrief">An IEEE 1588 PTP implementation designed for microcontrollers</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('_h743_ethernetif_modifications.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">STM32H743 low level lwIP driver modifications to support timestamp communication </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md6"></a>
lwIP low level driver modifications</h1>
<p>In the following you will find a modified version of the vendor-provided STM32H743 low level lwIP Ethernet driver. Both RX and TX functions have been modified so that timestamp capture upon reception and transmission are also supported.</p>
<p>The complete file is accessible is included at the end of this page.</p>
<h2><a class="anchor" id="autotoc_md7"></a>
Reception timestamps</h2>
<p>Into the function <code>pbuf_low_level_input()</code> we have inserted a small portion of code that copies the reception timestamp into the <code>pbuf</code>.</p>
<p>Inserted lines:</p>
<div class="fragment"><div class="line"><span class="comment">/* Store timestamp */</span></div>
<div class="line">p-&gt;time_s = RxBuff-&gt;ts_sec;</div>
<div class="line">p-&gt;time_ns = RxBuff-&gt;ts_nsec;</div>
</div><!-- fragment --><p>Complete function:</p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>pbuf * low_level_input(<span class="keyword">struct</span> netif *netif)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">struct </span>pbuf *p = NULL;</div>
<div class="line">  ETH_BufferTypeDef RxBuff[ETH_RX_DESC_CNT];</div>
<div class="line">  uint32_t framelength = 0, i = 0;;</div>
<div class="line">  <span class="keyword">struct </span>pbuf_custom* custom_pbuf;</div>
<div class="line"> </div>
<div class="line">  memset(RxBuff, 0 , ETH_RX_DESC_CNT*<span class="keyword">sizeof</span>(ETH_BufferTypeDef));</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">for</span>(i = 0; i &lt; ETH_RX_DESC_CNT -1; i++)</div>
<div class="line">  {</div>
<div class="line">    RxBuff[i].next=&amp;RxBuff[i+1];</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span>(HAL_ETH_GetRxDataBuffer(&amp;<a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>, RxBuff) == HAL_OK)</div>
<div class="line">  {</div>
<div class="line">    HAL_ETH_GetRxDataLength(&amp;<a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>, &amp;framelength);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Build Rx descriptor to be ready for next data reception */</span></div>
<div class="line">    HAL_ETH_BuildRxDescriptors(&amp;<a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Invalidate data cache for ETH Rx Buffers */</span></div>
<div class="line">    SCB_InvalidateDCache_by_Addr((uint32_t *)RxBuff-&gt;buffer, framelength);</div>
<div class="line">    </div>
<div class="line">    custom_pbuf  = (<span class="keyword">struct </span>pbuf_custom*)LWIP_MEMPOOL_ALLOC(RX_POOL);</div>
<div class="line">    <span class="keywordflow">if</span>(custom_pbuf != NULL)</div>
<div class="line">    {</div>
<div class="line">      custom_pbuf-&gt;custom_free_function = pbuf_free_custom;</div>
<div class="line"> </div>
<div class="line">      p = pbuf_alloced_custom(PBUF_RAW, framelength, PBUF_REF, custom_pbuf, RxBuff-&gt;buffer, framelength);</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* Store timestamp */</span></div>
<div class="line">      p-&gt;time_s = RxBuff-&gt;ts_sec;</div>
<div class="line">      p-&gt;time_ns = RxBuff-&gt;ts_nsec;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">return</span> p;</div>
<div class="line">}</div>
<div class="ttc" id="aflexptp__options__stm32h743_8h_html_a6d05c58b62fafdaf1d107abfc39ab8cf"><div class="ttname"><a href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a></div><div class="ttdeci">ETH_HandleTypeDef EthHandle</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md8"></a>
Transmission timestamps</h2>
<p>Several functions were modified and variables were declared in order to pass transmission timestamp back to the application through invoking callbacks.</p>
<h3><a class="anchor" id="autotoc_md9"></a>
Array for timestamp write back addresses</h3>
<p>An array was declared to temporarily hold the addresses where the transmit timestamps will be saved right after the packet transmission has completed.</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>pbuf *ppWriteBackPBufs[ETH_TX_DESC_CNT]; <span class="comment">/* pBuf array for timestamp writeback */</span></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md10"></a>
Procedure to save transmit timestamps</h3>
<p>A procedure was added that writes the transmit timestamp to their designated place. The routine is invoked whenever a frame transmission is done.</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> ethernetif_write_back_tx_timestamps() {</div>
<div class="line">    <span class="comment">/* store timestamps for transmitted frames */</span></div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j = 0; j &lt; ETH_TX_DESC_CNT; j++) {</div>
<div class="line">          ETH_DMADescTypeDef * pDesc = &amp;DMATxDscrTab[j];</div>
<div class="line">          <span class="keyword">struct </span>pbuf * pPBuf = ppWriteBackPBufs[j];</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">if</span> ((pPBuf != NULL) &amp;&amp; (!(pDesc-&gt;DESC3 &amp; ETH_DMATXNDESCWBF_OWN)) &amp;&amp; (pDesc-&gt;DESC3 &amp; ETH_DMATXNDESCWBF_LD) &amp;&amp; (pDesc-&gt;DESC3 &amp; ETH_DMATXNDESCWBF_TTSS)) {</div>
<div class="line">              <span class="comment">//MSG(&quot;* &quot;);</span></div>
<div class="line"> </div>
<div class="line">              pPBuf-&gt;time_s = pDesc-&gt;DESC1;</div>
<div class="line">              pPBuf-&gt;time_ns = pDesc-&gt;DESC0;</div>
<div class="line">              ppWriteBackPBufs[j] = NULL;</div>
<div class="line">              pDesc-&gt;DESC3 &amp;= ~ETH_DMATXNDESCWBF_TTSS;</div>
<div class="line"> </div>
<div class="line">              <span class="keywordflow">if</span> (pPBuf-&gt;ts_writeback_addr[0] != NULL) {</div>
<div class="line">                  *pPBuf-&gt;ts_writeback_addr[0] = pPBuf-&gt;time_s;</div>
<div class="line">              }</div>
<div class="line">              <span class="keywordflow">if</span> (pPBuf-&gt;ts_writeback_addr[1] != NULL) {</div>
<div class="line">                  *pPBuf-&gt;ts_writeback_addr[1] = pPBuf-&gt;time_ns;</div>
<div class="line">              }</div>
<div class="line">              <span class="keywordflow">if</span> (pPBuf-&gt;tx_cb) {</div>
<div class="line">                  pPBuf-&gt;tx_cb(pPBuf);</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">              pPBuf-&gt;tx_cb = NULL;</div>
<div class="line">              pPBuf-&gt;ts_writeback_addr[0] = NULL;</div>
<div class="line">              pPBuf-&gt;ts_writeback_addr[1] = NULL;</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> HAL_ETH_TxCpltCallback(ETH_HandleTypeDef * heth) {</div>
<div class="line">    ethernetif_write_back_tx_timestamps();</div>
<div class="line">}</div>
</div><!-- fragment --><p>If driver operates in polled mode, calling the writeback routine can be placed instead into the following function:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> ethernetif_input( <span class="keywordtype">void</span> <span class="keyword">const</span> * argument )</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">struct </span>pbuf *p;</div>
<div class="line">  <span class="keyword">struct </span>netif *netif = (<span class="keyword">struct </span>netif *) argument;</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">for</span>( ;; )</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (osSemaphoreWait( RxPktSemaphore, TIME_WAITING_FOR_INPUT)==osOK)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">do</span></div>
<div class="line">      {</div>
<div class="line">        p = low_level_input( netif );</div>
<div class="line">        <span class="keywordflow">if</span> (p != NULL)</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">if</span> (netif-&gt;input( p, netif) != ERR_OK )</div>
<div class="line">          {</div>
<div class="line">            pbuf_free(p);</div>
<div class="line">          }</div>
<div class="line">        }</div>
<div class="line">      }<span class="keywordflow">while</span>(p!=NULL);</div>
<div class="line"> </div>
<div class="line">      ethernetif_write_back_tx_timestamps();</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md11"></a>
Complete file</h2>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="comment">/* Includes ------------------------------------------------------------------*/</span></div>
<div class="line"><span class="preprocessor">#include &quot;stm32h7xx_hal.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;lwip/timeouts.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;netif/ethernet.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;netif/etharp.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;lwip/stats.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;lwip/snmp.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;lwip/tcpip.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;ethernetif.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;../Components/lan8742/lan8742.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;utils.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Private typedef -----------------------------------------------------------*/</span></div>
<div class="line"><span class="comment">/* Private define ------------------------------------------------------------*/</span></div>
<div class="line"><span class="comment">/* The time to block waiting for input. */</span></div>
<div class="line"><span class="preprocessor">#define TIME_WAITING_FOR_INPUT                 ( osWaitForever )</span></div>
<div class="line"><span class="comment">/* Stack size of the interface thread */</span></div>
<div class="line"><span class="preprocessor">#define INTERFACE_THREAD_STACK_SIZE            ( 350 )</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Define those to better describe your network interface. */</span></div>
<div class="line"><span class="preprocessor">#define IFNAME0 &#39;s&#39;</span></div>
<div class="line"><span class="preprocessor">#define IFNAME1 &#39;t&#39;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define ETH_RX_BUFFER_SIZE                     (1536UL)</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define ETH_DMA_TRANSMIT_TIMEOUT                (20U)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Private macro -------------------------------------------------------------*/</span></div>
<div class="line"><span class="comment">/* Private variables ---------------------------------------------------------*/</span></div>
<div class="line"><span class="comment">/* </span></div>
<div class="line"><span class="comment">@Note: This interface is implemented to operate in zero-copy mode only:</span></div>
<div class="line"><span class="comment">        - Rx buffers are allocated statically and passed directly to the LwIP stack,</span></div>
<div class="line"><span class="comment">          they will return back to ETH DMA after been processed by the stack.</span></div>
<div class="line"><span class="comment">        - Tx Buffers will be allocated from LwIP stack memory heap, </span></div>
<div class="line"><span class="comment">          then passed to ETH HAL driver.</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">@Notes: </span></div>
<div class="line"><span class="comment">  1.a. ETH DMA Rx descriptors must be contiguous, the default count is 4, </span></div>
<div class="line"><span class="comment">       to customize it please redefine ETH_RX_DESC_CNT in stm32xxxx_hal_conf.h</span></div>
<div class="line"><span class="comment">  1.b. ETH DMA Tx descriptors must be contiguous, the default count is 4, </span></div>
<div class="line"><span class="comment">       to customize it please redefine ETH_TX_DESC_CNT in stm32xxxx_hal_conf.h</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">  2.a. Rx Buffers number must be between ETH_RX_DESC_CNT and 2*ETH_RX_DESC_CNT</span></div>
<div class="line"><span class="comment">  2.b. Rx Buffers must have the same size: ETH_RX_BUFFER_SIZE, this value must</span></div>
<div class="line"><span class="comment">       passed to ETH DMA in the init field (EthHandle.Init.RxBuffLen)</span></div>
<div class="line"><span class="comment">  2.c  The RX Ruffers addresses and sizes must be properly defined to be aligned</span></div>
<div class="line"><span class="comment">       to L1-CACHE line size (32 bytes).</span></div>
<div class="line"><span class="comment">*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if defined ( __ICCARM__ ) </span></div>
<div class="line"><span class="preprocessor">#pragma location=0x30040000</span></div>
<div class="line">ETH_DMADescTypeDef  DMARxDscrTab[ETH_RX_DESC_CNT]; <span class="comment">/* Ethernet Rx DMA Descriptors */</span></div>
<div class="line"><span class="preprocessor">#pragma location=0x30040060</span></div>
<div class="line">ETH_DMADescTypeDef  DMATxDscrTab[ETH_TX_DESC_CNT]; <span class="comment">/* Ethernet Tx DMA Descriptors */</span></div>
<div class="line"><span class="preprocessor">#pragma location=0x30040200</span></div>
<div class="line">uint8_t Rx_Buff[ETH_RX_DESC_CNT][ETH_RX_BUFFER_SIZE]; <span class="comment">/* Ethernet Receive Buffers */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#elif defined ( __CC_ARM )  </span><span class="comment">/* MDK ARM Compiler */</span><span class="preprocessor"></span></div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="ptp__profile__presets_8c.html#ab898071398b359603a35c202e9c65f3b">__attribute__</a>((section(<span class="stringliteral">&quot;.RxDecripSection&quot;</span>))) ETH_DMADescTypeDef  DMARxDscrTab[ETH_RX_DESC_CNT]; <span class="comment">/* Ethernet Rx DMA Descriptors */</span></div>
<div class="line"><a class="code hl_function" href="ptp__profile__presets_8c.html#ab898071398b359603a35c202e9c65f3b">__attribute__</a>((section(&quot;.TxDecripSection&quot;))) ETH_DMADescTypeDef  DMATxDscrTab[ETH_TX_DESC_CNT]; <span class="comment">/* Ethernet Tx DMA Descriptors */</span></div>
<div class="line"><a class="code hl_function" href="ptp__profile__presets_8c.html#ab898071398b359603a35c202e9c65f3b">__attribute__</a>((section(&quot;.RxArraySection&quot;))) uint8_t Rx_Buff[ETH_RX_DESC_CNT][ETH_RX_BUFFER_SIZE]; <span class="comment">/* Ethernet Receive Buffer */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#elif defined ( __GNUC__ ) </span><span class="comment">/* GNU Compiler */</span><span class="preprocessor"> </span></div>
<div class="line"> </div>
<div class="line">ETH_DMADescTypeDef DMARxDscrTab[ETH_RX_DESC_CNT] <a class="code hl_function" href="ptp__profile__presets_8c.html#ab898071398b359603a35c202e9c65f3b">__attribute__</a>((section(<span class="stringliteral">&quot;.RxDecripSection&quot;</span>))); <span class="comment">/* Ethernet Rx DMA Descriptors */</span></div>
<div class="line">ETH_DMADescTypeDef DMATxDscrTab[ETH_TX_DESC_CNT] <a class="code hl_function" href="ptp__profile__presets_8c.html#ab898071398b359603a35c202e9c65f3b">__attribute__</a>((section(<span class="stringliteral">&quot;.TxDecripSection&quot;</span>)));   <span class="comment">/* Ethernet Tx DMA Descriptors */</span></div>
<div class="line">uint8_t Rx_Buff[ETH_RX_DESC_CNT][ETH_RX_BUFFER_SIZE] <a class="code hl_function" href="ptp__profile__presets_8c.html#ab898071398b359603a35c202e9c65f3b">__attribute__</a>((section(<span class="stringliteral">&quot;.RxArraySection&quot;</span>))); <span class="comment">/* Ethernet Receive Buffers */</span></div>
<div class="line"> </div>
<div class="line">uint8_t LwIP_HEAP[20*1024] <a class="code hl_function" href="ptp__profile__presets_8c.html#ab898071398b359603a35c202e9c65f3b">__attribute__</a>((section(<span class="stringliteral">&quot;.LwIPHEAP&quot;</span>))); <span class="comment">/* LwIP heap */</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>pbuf *ppWriteBackPBufs[ETH_TX_DESC_CNT]; <span class="comment">/* pBuf array for timestamp writeback */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line">ETH_HandleTypeDef <a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>;</div>
<div class="line">ETH_TxPacketConfig TxConfig; </div>
<div class="line"> </div>
<div class="line">lan8742_Object_t LAN8742;</div>
<div class="line"> </div>
<div class="line">osSemaphoreId RxPktSemaphore = NULL; <span class="comment">/* Semaphore to signal incoming packets */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Private function prototypes -----------------------------------------------*/</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ethernetif_input( <span class="keywordtype">void</span> <span class="keyword">const</span> * argument );</div>
<div class="line">u32_t    sys_now(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span>     pbuf_free_custom(<span class="keyword">struct</span> pbuf *p);</div>
<div class="line"> </div>
<div class="line">int32_t ETH_PHY_IO_Init(<span class="keywordtype">void</span>);</div>
<div class="line">int32_t ETH_PHY_IO_DeInit (<span class="keywordtype">void</span>);</div>
<div class="line">int32_t ETH_PHY_IO_ReadReg(uint32_t DevAddr, uint32_t RegAddr, uint32_t *pRegVal);</div>
<div class="line">int32_t ETH_PHY_IO_WriteReg(uint32_t DevAddr, uint32_t RegAddr, uint32_t RegVal);</div>
<div class="line">int32_t ETH_PHY_IO_GetTick(<span class="keywordtype">void</span>);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">lan8742_IOCtx_t  LAN8742_IOCtx = {ETH_PHY_IO_Init,</div>
<div class="line">                               ETH_PHY_IO_DeInit,</div>
<div class="line">                               ETH_PHY_IO_WriteReg,</div>
<div class="line">                               ETH_PHY_IO_ReadReg,</div>
<div class="line">                               ETH_PHY_IO_GetTick};</div>
<div class="line"> </div>
<div class="line">LWIP_MEMPOOL_DECLARE(RX_POOL, 10, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> pbuf_custom), <span class="stringliteral">&quot;Zero-copy RX PBUF pool&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ethernetif_write_back_tx_timestamps() {</div>
<div class="line">    <span class="comment">/* store timestamps for transmitted frames */</span></div>
<div class="line">      <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> j = 0; j &lt; ETH_TX_DESC_CNT; j++) {</div>
<div class="line">          ETH_DMADescTypeDef * pDesc = &amp;DMATxDscrTab[j];</div>
<div class="line">          <span class="keyword">struct </span>pbuf * pPBuf = ppWriteBackPBufs[j];</div>
<div class="line"> </div>
<div class="line">          <span class="keywordflow">if</span> ((pPBuf != NULL) &amp;&amp; (!(pDesc-&gt;DESC3 &amp; ETH_DMATXNDESCWBF_OWN)) &amp;&amp; (pDesc-&gt;DESC3 &amp; ETH_DMATXNDESCWBF_LD) &amp;&amp; (pDesc-&gt;DESC3 &amp; ETH_DMATXNDESCWBF_TTSS)) {</div>
<div class="line">              <span class="comment">//MSG(&quot;* &quot;);</span></div>
<div class="line"> </div>
<div class="line">              pPBuf-&gt;time_s = pDesc-&gt;DESC1;</div>
<div class="line">              pPBuf-&gt;time_ns = pDesc-&gt;DESC0;</div>
<div class="line">              ppWriteBackPBufs[j] = NULL;</div>
<div class="line">              pDesc-&gt;DESC3 &amp;= ~ETH_DMATXNDESCWBF_TTSS;</div>
<div class="line"> </div>
<div class="line">              <span class="keywordflow">if</span> (pPBuf-&gt;ts_writeback_addr[0] != NULL) {</div>
<div class="line">                  *pPBuf-&gt;ts_writeback_addr[0] = pPBuf-&gt;time_s;</div>
<div class="line">              }</div>
<div class="line">              <span class="keywordflow">if</span> (pPBuf-&gt;ts_writeback_addr[1] != NULL) {</div>
<div class="line">                  *pPBuf-&gt;ts_writeback_addr[1] = pPBuf-&gt;time_ns;</div>
<div class="line">              }</div>
<div class="line">              <span class="keywordflow">if</span> (pPBuf-&gt;tx_cb) {</div>
<div class="line">                  pPBuf-&gt;tx_cb(pPBuf);</div>
<div class="line">              }</div>
<div class="line"> </div>
<div class="line">              pPBuf-&gt;tx_cb = NULL;</div>
<div class="line">              pPBuf-&gt;ts_writeback_addr[0] = NULL;</div>
<div class="line">              pPBuf-&gt;ts_writeback_addr[1] = NULL;</div>
<div class="line">          }</div>
<div class="line">      }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> HAL_ETH_TxCpltCallback(ETH_HandleTypeDef * heth) {</div>
<div class="line">    ethernetif_write_back_tx_timestamps();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Private functions ---------------------------------------------------------*/</span></div>
<div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment">                       LL Driver Interface ( LwIP stack --&gt; ETH) </span></div>
<div class="line"><span class="comment">*******************************************************************************/</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> low_level_init(<span class="keyword">struct</span> netif *netif)</div>
<div class="line">{</div>
<div class="line">  uint32_t idx, duplex, speed = 0;</div>
<div class="line">  int32_t PHYLinkState;</div>
<div class="line">  ETH_MACConfigTypeDef MACConf;</div>
<div class="line">  uint8_t macaddress[6]= {ETH_MAC_ADDR0, ETH_MAC_ADDR1, ETH_MAC_ADDR2, ETH_MAC_ADDR3, ETH_MAC_ADDR4, ETH_MAC_ADDR5};</div>
<div class="line">  </div>
<div class="line">  <a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>.Instance = ETH;  </div>
<div class="line">  <a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>.Init.MACAddr = macaddress;</div>
<div class="line">  <a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>.Init.MediaInterface = HAL_ETH_RMII_MODE;</div>
<div class="line">  <a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>.Init.RxDesc = DMARxDscrTab;</div>
<div class="line">  <a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>.Init.TxDesc = DMATxDscrTab;</div>
<div class="line">  <a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>.Init.RxBuffLen = ETH_RX_BUFFER_SIZE;</div>
<div class="line">  </div>
<div class="line">  <span class="comment">/* configure ethernet peripheral (GPIOs, clocks, MAC, DMA) */</span></div>
<div class="line">  HAL_ETH_Init(&amp;<a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">/* set MAC hardware address length */</span></div>
<div class="line">  netif-&gt;hwaddr_len = ETH_HWADDR_LEN;</div>
<div class="line">  </div>
<div class="line">  <span class="comment">/* set MAC hardware address */</span></div>
<div class="line">  netif-&gt;hwaddr[0] =  ETH_MAC_ADDR0;</div>
<div class="line">  netif-&gt;hwaddr[1] =  ETH_MAC_ADDR1;</div>
<div class="line">  netif-&gt;hwaddr[2] =  ETH_MAC_ADDR2;</div>
<div class="line">  netif-&gt;hwaddr[3] =  ETH_MAC_ADDR3;</div>
<div class="line">  netif-&gt;hwaddr[4] =  ETH_MAC_ADDR4;</div>
<div class="line">  netif-&gt;hwaddr[5] =  ETH_MAC_ADDR5;</div>
<div class="line">  </div>
<div class="line">  <span class="comment">/* maximum transfer unit */</span></div>
<div class="line">  netif-&gt;mtu = ETH_MAX_PAYLOAD;</div>
<div class="line">  </div>
<div class="line">  <span class="comment">/* device capabilities */</span></div>
<div class="line">  <span class="comment">/* don&#39;t set NETIF_FLAG_ETHARP if this device is not an ethernet one */</span></div>
<div class="line">  netif-&gt;flags |= NETIF_FLAG_BROADCAST | NETIF_FLAG_ETHARP | NETIF_FLAG_IGMP;</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">for</span>(idx = 0; idx &lt; ETH_RX_DESC_CNT; idx ++)</div>
<div class="line">  {</div>
<div class="line">    HAL_ETH_DescAssignMemory(&amp;<a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>, idx, Rx_Buff[idx], NULL);</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  <span class="comment">/* Initialize the RX POOL */</span></div>
<div class="line">  LWIP_MEMPOOL_INIT(RX_POOL);</div>
<div class="line">  </div>
<div class="line">  memset(&amp;TxConfig, 0 , <span class="keyword">sizeof</span>(ETH_TxPacketConfig));  </div>
<div class="line">  TxConfig.Attributes = ETH_TX_PACKETS_FEATURES_CSUM | ETH_TX_PACKETS_FEATURES_CRCPAD;</div>
<div class="line">  TxConfig.ChecksumCtrl = ETH_CHECKSUM_IPHDR_PAYLOAD_INSERT_PHDR_CALC;</div>
<div class="line">  TxConfig.CRCPadCtrl = ETH_CRC_PAD_INSERT;</div>
<div class="line">   </div>
<div class="line">  <span class="comment">/* create a binary semaphore used for informing ethernetif of frame reception */</span></div>
<div class="line">  RxPktSemaphore = xSemaphoreCreateBinary();</div>
<div class="line">  </div>
<div class="line">  <span class="comment">/* create the task that handles the ETH_MAC */</span></div>
<div class="line">  osThreadDef(EthIf, ethernetif_input, osPriorityRealtime, 0, INTERFACE_THREAD_STACK_SIZE);</div>
<div class="line">  osThreadCreate (osThread(EthIf), netif);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">/* Set PHY IO functions */</span></div>
<div class="line">  LAN8742_RegisterBusIO(&amp;LAN8742, &amp;LAN8742_IOCtx);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">/* Initialize the LAN8742 ETH PHY */</span></div>
<div class="line">  LAN8742_Init(&amp;LAN8742);</div>
<div class="line">  </div>
<div class="line">  PHYLinkState = LAN8742_GetLinkState(&amp;LAN8742);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">/* Get link state */</span>  </div>
<div class="line">  <span class="keywordflow">if</span>(PHYLinkState &lt;= LAN8742_STATUS_LINK_DOWN)</div>
<div class="line">  {</div>
<div class="line">    netif_set_link_down(netif);</div>
<div class="line">    netif_set_down(netif);</div>
<div class="line">  }</div>
<div class="line">  <span class="keywordflow">else</span> </div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">switch</span> (PHYLinkState)</div>
<div class="line">    {</div>
<div class="line">    <span class="keywordflow">case</span> LAN8742_STATUS_100MBITS_FULLDUPLEX:</div>
<div class="line">      duplex = ETH_FULLDUPLEX_MODE;</div>
<div class="line">      speed = ETH_SPEED_100M;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> LAN8742_STATUS_100MBITS_HALFDUPLEX:</div>
<div class="line">      duplex = ETH_HALFDUPLEX_MODE;</div>
<div class="line">      speed = ETH_SPEED_100M;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> LAN8742_STATUS_10MBITS_FULLDUPLEX:</div>
<div class="line">      duplex = ETH_FULLDUPLEX_MODE;</div>
<div class="line">      speed = ETH_SPEED_10M;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> LAN8742_STATUS_10MBITS_HALFDUPLEX:</div>
<div class="line">      duplex = ETH_HALFDUPLEX_MODE;</div>
<div class="line">      speed = ETH_SPEED_10M;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">      duplex = ETH_FULLDUPLEX_MODE;</div>
<div class="line">      speed = ETH_SPEED_100M;</div>
<div class="line">      <span class="keywordflow">break</span>;      </div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Get MAC Config MAC */</span></div>
<div class="line">    HAL_ETH_GetMACConfig(&amp;<a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>, &amp;MACConf); </div>
<div class="line">    MACConf.DuplexMode = duplex;</div>
<div class="line">    MACConf.Speed = speed;</div>
<div class="line">    HAL_ETH_SetMACConfig(&amp;<a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>, &amp;MACConf);</div>
<div class="line">    HAL_ETH_Start_IT(&amp;<a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>);</div>
<div class="line">    netif_set_up(netif);</div>
<div class="line">    netif_set_link_up(netif);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> err_t low_level_output(<span class="keyword">struct</span> netif *netif, <span class="keyword">struct</span> pbuf *p)</div>
<div class="line">{</div>
<div class="line">  uint32_t i=0;</div>
<div class="line">  <span class="keyword">struct </span>pbuf *q;</div>
<div class="line">  err_t errval = ERR_OK;</div>
<div class="line">  ETH_BufferTypeDef Txbuffer[ETH_TX_DESC_CNT];</div>
<div class="line">  </div>
<div class="line">  memset(Txbuffer, 0 , ETH_TX_DESC_CNT*<span class="keyword">sizeof</span>(ETH_BufferTypeDef));</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span>(q = p; q != NULL; q = q-&gt;next)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span>(i &gt;= ETH_TX_DESC_CNT)    </div>
<div class="line">      <span class="keywordflow">return</span> ERR_IF;</div>
<div class="line">    </div>
<div class="line">    Txbuffer[i].buffer = q-&gt;payload;</div>
<div class="line">    Txbuffer[i].len = q-&gt;len;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span>(i&gt;0)</div>
<div class="line">    {</div>
<div class="line">      Txbuffer[i-1].next = &amp;Txbuffer[i];</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span>(q-&gt;next == NULL)</div>
<div class="line">    {</div>
<div class="line">      Txbuffer[i].next = NULL;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    i++;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  TxConfig.Length = p-&gt;tot_len;</div>
<div class="line">  TxConfig.TxBuffer = Txbuffer;</div>
<div class="line"> </div>
<div class="line">  ppWriteBackPBufs[<a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>.TxDescList.CurTxDesc] = p;</div>
<div class="line"> </div>
<div class="line">  HAL_ETH_Transmit(&amp;<a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>, &amp;TxConfig, ETH_DMA_TRANSMIT_TIMEOUT);</div>
<div class="line">  <span class="comment">//HAL_ETH_Transmit_IT(&amp;EthHandle, &amp;TxConfig);</span></div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">return</span> errval;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>pbuf * low_level_input(<span class="keyword">struct</span> netif *netif)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">struct </span>pbuf *p = NULL;</div>
<div class="line">  ETH_BufferTypeDef RxBuff[ETH_RX_DESC_CNT];</div>
<div class="line">  uint32_t framelength = 0, i = 0;;</div>
<div class="line">  <span class="keyword">struct </span>pbuf_custom* custom_pbuf;</div>
<div class="line"> </div>
<div class="line">  memset(RxBuff, 0 , ETH_RX_DESC_CNT*<span class="keyword">sizeof</span>(ETH_BufferTypeDef));</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">for</span>(i = 0; i &lt; ETH_RX_DESC_CNT -1; i++)</div>
<div class="line">  {</div>
<div class="line">    RxBuff[i].next=&amp;RxBuff[i+1];</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span>(HAL_ETH_GetRxDataBuffer(&amp;<a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>, RxBuff) == HAL_OK)</div>
<div class="line">  {</div>
<div class="line">    HAL_ETH_GetRxDataLength(&amp;<a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>, &amp;framelength);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Build Rx descriptor to be ready for next data reception */</span></div>
<div class="line">    HAL_ETH_BuildRxDescriptors(&amp;<a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Invalidate data cache for ETH Rx Buffers */</span></div>
<div class="line">    SCB_InvalidateDCache_by_Addr((uint32_t *)RxBuff-&gt;buffer, framelength);</div>
<div class="line">    </div>
<div class="line">    custom_pbuf  = (<span class="keyword">struct </span>pbuf_custom*)LWIP_MEMPOOL_ALLOC(RX_POOL);</div>
<div class="line">    <span class="keywordflow">if</span>(custom_pbuf != NULL)</div>
<div class="line">    {</div>
<div class="line">      custom_pbuf-&gt;custom_free_function = pbuf_free_custom;</div>
<div class="line"> </div>
<div class="line">      p = pbuf_alloced_custom(PBUF_RAW, framelength, PBUF_REF, custom_pbuf, RxBuff-&gt;buffer, framelength);</div>
<div class="line"> </div>
<div class="line">      <span class="comment">/* Store timestamp */</span></div>
<div class="line">      p-&gt;time_s = RxBuff-&gt;ts_sec;</div>
<div class="line">      p-&gt;time_ns = RxBuff-&gt;ts_nsec;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">return</span> p;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ethernetif_input( <span class="keywordtype">void</span> <span class="keyword">const</span> * argument )</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">struct </span>pbuf *p;</div>
<div class="line">  <span class="keyword">struct </span>netif *netif = (<span class="keyword">struct </span>netif *) argument;</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">for</span>( ;; )</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">if</span> (osSemaphoreWait( RxPktSemaphore, TIME_WAITING_FOR_INPUT)==osOK)</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">do</span></div>
<div class="line">      {</div>
<div class="line">        p = low_level_input( netif );</div>
<div class="line">        <span class="keywordflow">if</span> (p != NULL)</div>
<div class="line">        {</div>
<div class="line">          <span class="keywordflow">if</span> (netif-&gt;input( p, netif) != ERR_OK )</div>
<div class="line">          {</div>
<div class="line">            pbuf_free(p);</div>
<div class="line">          }</div>
<div class="line">        }</div>
<div class="line">      }<span class="keywordflow">while</span>(p!=NULL);</div>
<div class="line"> </div>
<div class="line">      ethernetif_write_back_tx_timestamps();</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">err_t ethernetif_init(<span class="keyword">struct</span> netif *netif)</div>
<div class="line">{</div>
<div class="line">  LWIP_ASSERT(<span class="stringliteral">&quot;netif != NULL&quot;</span>, (netif != NULL));</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if LWIP_NETIF_HOSTNAME</span></div>
<div class="line">  <span class="comment">/* Initialize interface hostname */</span></div>
<div class="line">  netif-&gt;hostname = <span class="stringliteral">&quot;lwip&quot;</span>;</div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* LWIP_NETIF_HOSTNAME */</span><span class="preprocessor"></span></div>
<div class="line">  </div>
<div class="line">  <span class="comment">/*</span></div>
<div class="line"><span class="comment">     Initialize the snmp variables and counters inside the struct netif.</span></div>
<div class="line"><span class="comment">     The last argument should be replaced with your link speed, in units</span></div>
<div class="line"><span class="comment">     of bits per second.</span></div>
<div class="line"><span class="comment">   */</span></div>
<div class="line">  MIB2_INIT_NETIF(netif, snmp_ifType_ethernet_csmacd, LINK_SPEED_OF_YOUR_NETIF_IN_BPS);</div>
<div class="line"> </div>
<div class="line">  netif-&gt;name[0] = IFNAME0;</div>
<div class="line">  netif-&gt;name[1] = IFNAME1;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* We directly use etharp_output() here to save a function call.</span></div>
<div class="line"><span class="comment">     You can instead declare your own function an call etharp_output()</span></div>
<div class="line"><span class="comment">     from it if you have to do some checks before sending (e.g. if link</span></div>
<div class="line"><span class="comment">     is available...) */</span></div>
<div class="line">  netif-&gt;output = etharp_output;</div>
<div class="line">  netif-&gt;linkoutput = low_level_output;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* initialize the hardware */</span></div>
<div class="line">  low_level_init(netif);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> ERR_OK;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> pbuf_free_custom(<span class="keyword">struct</span> pbuf *p)</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">struct </span>pbuf_custom* custom_pbuf = (<span class="keyword">struct </span>pbuf_custom*)p;</div>
<div class="line">  LWIP_MEMPOOL_FREE(RX_POOL, custom_pbuf);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">u32_t sys_now(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> HAL_GetTick();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment">                       Ethernet MSP Routines</span></div>
<div class="line"><span class="comment">*******************************************************************************/</span></div>
<div class="line"><span class="keywordtype">void</span> HAL_ETH_MspInit(ETH_HandleTypeDef *heth)</div>
<div class="line">{</div>
<div class="line">  GPIO_InitTypeDef GPIO_InitStructure;</div>
<div class="line">  </div>
<div class="line">  <span class="comment">/* Ethernett MSP init: RMII Mode */</span></div>
<div class="line">  </div>
<div class="line">  <span class="comment">/* Enable GPIOs clocks */</span></div>
<div class="line">  __HAL_RCC_GPIOA_CLK_ENABLE();</div>
<div class="line">  __HAL_RCC_GPIOB_CLK_ENABLE();</div>
<div class="line">  __HAL_RCC_GPIOC_CLK_ENABLE();</div>
<div class="line">  __HAL_RCC_GPIOG_CLK_ENABLE();</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Ethernet pins configuration ************************************************/</span></div>
<div class="line">  <span class="comment">/*</span></div>
<div class="line"><span class="comment">        RMII_REF_CLK ----------------------&gt; PA1</span></div>
<div class="line"><span class="comment">        RMII_MDIO -------------------------&gt; PA2</span></div>
<div class="line"><span class="comment">        RMII_MDC --------------------------&gt; PC1</span></div>
<div class="line"><span class="comment">        RMII_MII_CRS_DV -------------------&gt; PA7</span></div>
<div class="line"><span class="comment">        RMII_MII_RXD0 ---------------------&gt; PC4</span></div>
<div class="line"><span class="comment">        RMII_MII_RXD1 ---------------------&gt; PC5</span></div>
<div class="line"><span class="comment">        RMII_MII_RXER ---------------------&gt; PG2</span></div>
<div class="line"><span class="comment">        RMII_MII_TX_EN --------------------&gt; PG11</span></div>
<div class="line"><span class="comment">        RMII_MII_TXD0 ---------------------&gt; PG13</span></div>
<div class="line"><span class="comment">        RMII_MII_TXD1 ---------------------&gt; PB13</span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Configure PA1, PA2 and PA7 */</span></div>
<div class="line">  GPIO_InitStructure.Speed = GPIO_SPEED_FREQ_HIGH;</div>
<div class="line">  GPIO_InitStructure.Mode = GPIO_MODE_AF_PP;</div>
<div class="line">  GPIO_InitStructure.Pull = GPIO_NOPULL; </div>
<div class="line">  GPIO_InitStructure.Alternate = GPIO_AF11_ETH;</div>
<div class="line">  GPIO_InitStructure.Pin = GPIO_PIN_1 | GPIO_PIN_2 | GPIO_PIN_7;</div>
<div class="line">  HAL_GPIO_Init(GPIOA, &amp;GPIO_InitStructure);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">/* Configure PB13 */</span></div>
<div class="line">  GPIO_InitStructure.Pin = GPIO_PIN_13;</div>
<div class="line">  HAL_GPIO_Init(GPIOB, &amp;GPIO_InitStructure);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">/* Configure PC1, PC4 and PC5 */</span></div>
<div class="line">  GPIO_InitStructure.Pin = GPIO_PIN_1 | GPIO_PIN_4 | GPIO_PIN_5;</div>
<div class="line">  HAL_GPIO_Init(GPIOC, &amp;GPIO_InitStructure);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">/* Configure PG2, PG11, PG13 and PG14 */</span></div>
<div class="line">  GPIO_InitStructure.Pin =  GPIO_PIN_2 | GPIO_PIN_11 | GPIO_PIN_13;</div>
<div class="line">  HAL_GPIO_Init(GPIOG, &amp;GPIO_InitStructure);    </div>
<div class="line">  </div>
<div class="line">  <span class="comment">/* Enable the Ethernet global Interrupt */</span></div>
<div class="line">  HAL_NVIC_SetPriority(ETH_IRQn, 0x7, 0);</div>
<div class="line">  HAL_NVIC_EnableIRQ(ETH_IRQn);</div>
<div class="line">  </div>
<div class="line">  <span class="comment">/* Enable Ethernet clocks */</span></div>
<div class="line">  __HAL_RCC_ETH1MAC_CLK_ENABLE();</div>
<div class="line">  __HAL_RCC_ETH1TX_CLK_ENABLE();</div>
<div class="line">  __HAL_RCC_ETH1RX_CLK_ENABLE();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> HAL_ETH_RxCpltCallback(ETH_HandleTypeDef *heth)</div>
<div class="line">{</div>
<div class="line">  osSemaphoreRelease(RxPktSemaphore);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment">                       PHI IO Functions</span></div>
<div class="line"><span class="comment">*******************************************************************************/</span></div>
<div class="line">int32_t ETH_PHY_IO_Init(<span class="keywordtype">void</span>)</div>
<div class="line">{  </div>
<div class="line">  <span class="comment">/* We assume that MDIO GPIO configuration is already done</span></div>
<div class="line"><span class="comment">     in the ETH_MspInit() else it should be done here </span></div>
<div class="line"><span class="comment">  */</span></div>
<div class="line">  </div>
<div class="line">  <span class="comment">/* Configure the MDIO Clock */</span></div>
<div class="line">  HAL_ETH_SetMDIOClockRange(&amp;<a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>);</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">int32_t ETH_PHY_IO_DeInit (<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">int32_t ETH_PHY_IO_ReadReg(uint32_t DevAddr, uint32_t RegAddr, uint32_t *pRegVal)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span>(HAL_ETH_ReadPHYRegister(&amp;<a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>, DevAddr, RegAddr, pRegVal) != HAL_OK)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">int32_t ETH_PHY_IO_WriteReg(uint32_t DevAddr, uint32_t RegAddr, uint32_t RegVal)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">if</span>(HAL_ETH_WritePHYRegister(&amp;<a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>, DevAddr, RegAddr, RegVal) != HAL_OK)</div>
<div class="line">  {</div>
<div class="line">    <span class="keywordflow">return</span> -1;</div>
<div class="line">  }</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">int32_t ETH_PHY_IO_GetTick(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">  <span class="keywordflow">return</span> HAL_GetTick();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> ethernet_link_thread( <span class="keywordtype">void</span> <span class="keyword">const</span> * argument )</div>
<div class="line">{</div>
<div class="line">  ETH_MACConfigTypeDef MACConf;</div>
<div class="line">  int32_t PHYLinkState;</div>
<div class="line">  uint32_t linkchanged = 0, speed = 0, duplex =0;</div>
<div class="line">  <span class="keyword">struct </span>netif *netif = (<span class="keyword">struct </span>netif *) argument;</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">for</span>(;;)</div>
<div class="line">  {</div>
<div class="line">    </div>
<div class="line">    PHYLinkState = LAN8742_GetLinkState(&amp;LAN8742);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span>(netif_is_link_up(netif) &amp;&amp; (PHYLinkState &lt;= LAN8742_STATUS_LINK_DOWN))</div>
<div class="line">    {</div>
<div class="line">      HAL_ETH_Stop_IT(&amp;<a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>);</div>
<div class="line">      netif_set_down(netif);</div>
<div class="line">      netif_set_link_down(netif);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!netif_is_link_up(netif) &amp;&amp; (PHYLinkState &gt; LAN8742_STATUS_LINK_DOWN))</div>
<div class="line">    {</div>
<div class="line">      <span class="keywordflow">switch</span> (PHYLinkState)</div>
<div class="line">      {</div>
<div class="line">      <span class="keywordflow">case</span> LAN8742_STATUS_100MBITS_FULLDUPLEX:</div>
<div class="line">        duplex = ETH_FULLDUPLEX_MODE;</div>
<div class="line">        speed = ETH_SPEED_100M;</div>
<div class="line">        linkchanged = 1;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      <span class="keywordflow">case</span> LAN8742_STATUS_100MBITS_HALFDUPLEX:</div>
<div class="line">        duplex = ETH_HALFDUPLEX_MODE;</div>
<div class="line">        speed = ETH_SPEED_100M;</div>
<div class="line">        linkchanged = 1;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      <span class="keywordflow">case</span> LAN8742_STATUS_10MBITS_FULLDUPLEX:</div>
<div class="line">        duplex = ETH_FULLDUPLEX_MODE;</div>
<div class="line">        speed = ETH_SPEED_10M;</div>
<div class="line">        linkchanged = 1;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      <span class="keywordflow">case</span> LAN8742_STATUS_10MBITS_HALFDUPLEX:</div>
<div class="line">        duplex = ETH_HALFDUPLEX_MODE;</div>
<div class="line">        speed = ETH_SPEED_10M;</div>
<div class="line">        linkchanged = 1;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      <span class="keywordflow">default</span>:</div>
<div class="line">        <span class="keywordflow">break</span>;      </div>
<div class="line">      }</div>
<div class="line">      </div>
<div class="line">      <span class="keywordflow">if</span>(linkchanged)</div>
<div class="line">      {</div>
<div class="line">        <span class="comment">/* Get MAC Config MAC */</span></div>
<div class="line">        HAL_ETH_GetMACConfig(&amp;<a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>, &amp;MACConf); </div>
<div class="line">        MACConf.DuplexMode = duplex;</div>
<div class="line">        MACConf.Speed = speed;</div>
<div class="line">        HAL_ETH_SetMACConfig(&amp;<a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>, &amp;MACConf);</div>
<div class="line">        HAL_ETH_Start_IT(&amp;<a class="code hl_variable" href="flexptp__options__stm32h743_8h.html#a6d05c58b62fafdaf1d107abfc39ab8cf">EthHandle</a>);</div>
<div class="line">        netif_set_up(netif);</div>
<div class="line">        netif_set_link_up(netif);</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    osDelay(100);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/************************ (C) COPYRIGHT STMicroelectronics *****END OF FILE****/</span></div>
<div class="ttc" id="aptp__profile__presets_8c_html_ab898071398b359603a35c202e9c65f3b"><div class="ttname"><a href="ptp__profile__presets_8c.html#ab898071398b359603a35c202e9c65f3b">__attribute__</a></div><div class="ttdeci">struct __attribute__((packed))</div><div class="ttdef"><b>Definition:</b> <a href="ptp__profile__presets_8c_source.html#l00001">ptp_profile_presets.c:25</a></div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="index.html">Introduction and overview</a></li><li class="navelem"><a class="el" href="examples.html">Examples</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6 </li>
  </ul>
</div>
</body>
</html>

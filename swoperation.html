<!-- HTML header for doxygen 1.9.8-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>flexPTP: Software structure</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="large-top-height.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript">
    DoxygenAwesomeFragmentCopyButton.init()
</script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript">
    DoxygenAwesomeInteractiveToc.init()
</script>
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
    DoxygenAwesomeDarkModeToggle.init()
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="flexPTP_logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">flexPTP<span id="projectnumber">&#160;1.0</span>
   </div>
   <div id="projectbrief">An IEEE 1588 PTP implementation designed for microcontrollers</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('swoperation.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Software structure </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="image">
<img src="software_structure.png" alt=""/>
<div class="caption">
flexPTP Software Structure</div></div>
    <p>The software's inner structure is presented on the figure above. The heart of the flexPTP library is the <a class="el" href="swoperation.html#core">Core</a> module coordinating the operation of the <a class="el" href="swoperation.html#master">Master</a> and <a class="el" href="swoperation.html#slave">Slave</a> blocks based on the information provided by the <a class="el" href="swoperation.html#best-master-clock-algorithm">BMCA</a>. All helper functions a miscellaneous utilities are summarized in the <em>Utils</em> block. The linked components are discussed in the <a class="el" href="swoperation.html#external-modules">External modules</a> section.</p>
<p>Many Internal module feature specific logging options, to learn more refer to <a class="el" href="monitoring.html">Events and logging</a>.</p>
<h1><a class="anchor" id="autotoc_md81"></a>
Internal modules</h1>
<h2><a class="anchor" id="core"></a>
Core</h2>
<p>This module is responsible for initializing the library and initiating reset procedure and propagating them to the subordinate modules. There's also a heartbeat timer (125ms period by default, see <a class="el" href="porting.html#port-config-opmode-params">PTP_HEARTBEAT_TICKRATE_MS</a>) defined in this module to make scheduling throughout the library possible without raising race-conditions. Also note no messaging frequency can be greater than the frequency of this clock. That's why, the default minimum log. period for all messages is -3 (see <code>PTP_LOGPER_MIN</code>). This module also handles the receive and transmit messaging queues and a separate event queue used for inter-module communication. The FreeRTOS task associated with the library is defined and configured by this module too.</p>
<p>The core module itself is not processing PTP messages, just filters and forwards them to the relevant modules. Only messages matching the current profile (Delay Mechanism, Transport Type, Domain, Transport Specific) are passed through. Messages generated and received by the specific blocks are indicated on the block diagram.</p>
<h3><a class="anchor" id="autotoc_md82"></a>
Initialization</h3>
<p>The initialize of the library start with invoking calling <a class="el" href="task__ptp_8c.html#a2d483d3c32b3890d8c699018e48e45cd">reg_task_ptp()</a>. This function constructs the input, output and event queues, loads the hardware address, initializes the subordinate (BMCA (<a class="el" href="bmca_8c.html#a7e5c40fe2c860e51dfca0f10d9395625">ptp_bmca_init()</a>), Master (<a class="el" href="master_8c.html#a7acd581b1d1177a3b24b80abb8e15df4">ptp_master_init()</a>), Slave (<a class="el" href="slave_8c.html#a30aa49f0ba417a3c8c6a820568b4d61a">ptp_slave_init()</a>)) modules, the Network Stack Driver, the Hardware Port (<a class="el" href="flexptp__options__ch32f207__etherlib_8h.html#a45ea2e992dddae826985c1cfc4b9c8db">PTP_HW_INIT()</a>), the Servo and finally creates the "ptp" task. The task listens for available items on any of the queues, pulls them and initiates the processing. The implementation relies on the FreeRTOS QueueSet feature.</p>
<h3><a class="anchor" id="autotoc_md83"></a>
Reset</h3>
<p>Whenever a library reset is issued by calling <a class="el" href="ptp__core_8c.html#a52febb700b5a0f2af1bc5f31d43593ce">ptp_reset()</a>, the call is propagated toward all subordinate blocks (<a class="el" href="bmca_8c.html#a990240d152a52b7c27a73f6fb8fa3e5c">ptp_bmca_reset()</a>, <a class="el" href="master_8c.html#a694d45271891817978b6b401f0288b88">ptp_master_reset()</a>, <a class="el" href="slave_8c.html#a90a31f932773e9b3ed5b9decb305025f">ptp_slave_reset()</a>). Generally, a reset clears state machines and statistics, but does not touch the PTP profile, clock offset and priority settings.</p>
<h2><a class="anchor" id="best-master-clock-algorithm"></a>
Best Master Clock Algorithm</h2>
<p>This module contains a slightly simplified, but IEEE 1588 compatible implementation of the Best Master Clock Algorithm. The state chart is the following:</p>
<div class="image">
<img src="simplified_bmca_state_chart.png" alt=""/>
<div class="caption">
BMCA state chart</div></div>
    <p>The BMCA algorithm operates based on the data in our clock's dataset (refer to <a class="el" href="porting.html#port-config-clock-dataset">Clock dataset</a>) and based on information shipped in Announce messages. No other messaging is channeled into this module and no messages are generated by the BMCA.</p>
<p>Upon a BMCA state change the Core module is notified through an event to enable and disable the Master and Slave modules.</p>
<p>To configure BMCA parameters set <a class="el" href="porting.html#port-config-BMCA">BMCA</a> macros.</p>
<h2><a class="anchor" id="master"></a>
Master</h2>
<p>This module implements the Master clock functionality. This module is enabled whenever the BMCA elects us for Best Master, i.e. the BMCA state is <code>MASTER</code>. The module periodically issues all Master-related PTP messages indicated in the top figure.</p>
<p>The Master module can be disabled in compile time using the <a class="el" href="porting.html#port-config-master">PTP_ENABLE_MASTER_OPERATION</a> macro if a Slave-only operation was desired.</p>
<p>There're a couple of runtime-settable flags also influencing the Master mode. Some profile presets also use these features.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Flag   </th><th class="markdownTableHeadNone">Value   </th><th class="markdownTableHeadNone">Description    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>PTP_PF_ISSUE_SYNC_FOR_COMPLIANT_SLAVE_ONLY_IN_P2P</code>   </td><td class="markdownTableBodyNone"><code>0x01</code>   </td><td class="markdownTableBodyNone">Send Sync messages only for a compliant peer in P2P mode    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>PTP_PF_SLAVE_ONLY</code>   </td><td class="markdownTableBodyNone"><code>0x02</code>   </td><td class="markdownTableBodyNone">Operate Slave-only   </td></tr>
</table>
<h3><a class="anchor" id="autotoc_md84"></a>
Compliant peer</h3>
<p>Mostly in gPTP mode, the Master clock only commences sending Sync messages if the peer has responded Master's PDelay_Req messages for a while, the Mean Path Delay to the Slave is below a specific threshold and some other criteria has been met. In flexPTP's term this concept is called "Compliant peer" and only the continuity and message frequency are checked. To learn more about this feature, refer to <a class="el" href="master_8c.html#a52223c8d17198c7bbcf0b8df3231a7e0">ptp_master_p2p_slave_reported()</a> and <a class="el" href="master_8c.html#ab718b2aadd86029ab22006d4822a3830">ptp_master_process_message()</a>.</p>
<h3><a class="anchor" id="autotoc_md85"></a>
P2P Mean Path Delay</h3>
<p>In P2P modes Mean Path Delay is calculated using the following formulae taken from the IEEE 1588 Standard, considering we have issued the initiating PDelay_Req:</p>
<h4><a class="anchor" id="autotoc_md86"></a>
Two-step clock mode</h4>
<p>\( \text{MPD} = \frac{(T_\text{PDelay_Resp_RX} - T_\text{PDelay_Resp_TX}) - (T_\text{PDelay_Req_TX} - T_\text{PDelay_Req_RX}) - (\text{CF}_\text{PDelay_Resp} + \text{CF}_\text{PDelay_Resp_Follow_Up})}{2}\)</p>
<h4><a class="anchor" id="autotoc_md87"></a>
One-step clock mode</h4>
<p>\( \text{MPD} = \frac{(T_\text{PDelay_Resp_RX} - T_\text{PDelay_Req_TX}) - \text{CF}_\text{PDelay_Resp}}{2}\)</p>
<h2><a class="anchor" id="slave"></a>
Slave</h2>
<p>This module implements the Slave clock functionality. This module is enabled whenever the BMCA decides there're better masters on the network than us or if the Master module is completely disabled through the compile time configuration.</p>
<p>All messages indicated in the top figure channelled into the Slave module are processed in the <a class="el" href="slave_8c.html#a591f9730a29b5536e2590e3689a813fe">ptp_slave_process_message()</a> function, which later invokes <a class="el" href="slave_8c.html#aafe19c39152756b0911651260674330a">ptp_perform_correction()</a> to compute time error and execute the servo algorithm.</p>
<h3><a class="anchor" id="autotoc_md88"></a>
Time error</h3>
<p>Time error is computed using the following formula, based on the IEEE 1588 Standard:</p>
<p>\( \Delta t = T_\text{Sync_RX} - T_\text{Sync_TX} - \text{MPD} - (\text{CF}_\text{Sync} + \text{CF}_\text{Follow_Up})\)</p>
<h3><a class="anchor" id="autotoc_md89"></a>
Mean Path Delay</h3>
<p>Mean Path Delay is calculated using the following formulae, based on the IEEE 1588 Standard:</p>
<h4><a class="anchor" id="autotoc_md90"></a>
Two-step clock mode</h4>
<p>\( \text{MPD} = \frac{T_\text{Sync_RX} - T_\text{Sync_TX} - (T_\text{Delay_Req_TX} - T_\text{Delay_Req_RX}) - (\text{CF}_\text{Sync} + \text{CF}_\text{Follow_Up} + \text{CF}_\text{Delay_Resp})}{2} \)</p>
<h4><a class="anchor" id="autotoc_md91"></a>
One-step clock mode</h4>
<p>\( \text{MPD} = \frac{T_\text{Sync_RX} - T_\text{Sync_TX} - (T_\text{Delay_Req_TX} - T_\text{Delay_Req_RX}) - (\text{CF}_\text{Sync} + \text{CF}_\text{Delay_Resp})}{2} \)</p>
<h1><a class="anchor" id="external-modules"></a>
External modules</h1>
<p>The structure and purpose of External modules are discussed deeply in <a class="el" href="porting.html">Porting and configuration</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6 </li>
  </ul>
</div>
</body>
</html>
